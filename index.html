<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GTA Orders Map (URL data → Auto Refresh)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Arial}
    .wrap{display:grid;grid-template-rows:auto 1fr;height:100vh}
    header{padding:10px 12px;border-bottom:1px solid #ddd;display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
    textarea{width:min(820px, 100%);height:150px}
    .btn{padding:8px 12px;border:1px solid #aaa;background:#fff;cursor:pointer;border-radius:6px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .hint{color:#555;font-size:13px;max-width:980px}
    #map{height:100%}
    .pill{padding:4px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#333;white-space:nowrap}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px;color:#444}
    select,input[type="number"]{padding:6px 8px;border-radius:6px;border:1px solid #aaa;background:#fff}
    input[type="range"]{width:180px}
    code{background:#f6f6f6;padding:2px 5px;border-radius:4px}
    .panel{
      border:1px solid #ddd;border-radius:10px;padding:10px 12px;min-width:320px;
      background:#fafafa;
    }
    .panel h3{margin:0 0 8px 0;font-size:14px}
    .grid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px 10px;
      align-items:center;
    }
    .grid label{font-size:12px;color:#333}
    .muted{color:#666;font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div style="flex:1;min-width:280px">
      <div class="row">
        <b>Paste summary table</b>
        <span class="pill">Format: Location, Lat, Lng, Qty, Amount</span>
        <span class="pill">Comma or Tab separated</span>
      </div>

      <textarea id="input" spellcheck="false" placeholder="Example:
Glen Oaks,43.8727,-79.3185,14,5323.08
Mt Hope,43.6932,-79.6200,12,4878.88
Resurrection,43.7684,-79.2983,11,4588.38"></textarea>

      <div class="hint">
        <b>URL auto-load:</b> append <code class="mono">?data=...</code> (URL-encoded). Example:
        <code class="mono">?data=Glen%20Oaks%2C43.8727%2C-79.3185%2C14%2C5323.08%0AMt%20Hope%2C...</code>
      </div>
    </div>

    <div class="panel">
      <h3>Settings</h3>

      <div class="grid">
        <label for="sizeBy">Bubble size by</label>
        <select id="sizeBy">
          <option value="qty" selected>Qty</option>
          <option value="amount">Amount</option>
        </select>

        <label for="bubbleColor">Bubble color</label>
        <input id="bubbleColor" type="color" value="#3b82f6" />

        <label for="bubbleOpacity">Bubble transparency</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="bubbleOpacity" type="range" min="0.10" max="1.00" step="0.05" value="0.55" />
          <span class="small" id="bubbleOpacityLabel">0.55</span>
        </div>

        <label for="twoScale">2-scale colouring</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="twoScale" type="checkbox" />
          <span class="muted">Enable</span>
        </div>

        <label for="thresholdMetric">Threshold metric</label>
        <select id="thresholdMetric">
          <option value="amount" selected>Amount</option>
          <option value="qty">Qty</option>
        </select>

        <label for="thresholdValue">Threshold value</label>
        <input id="thresholdValue" type="number" value="5000" step="1" min="0" />

        <label for="highColor">Above-threshold color</label>
        <input id="highColor" type="color" value="#ef4444" />
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="refresh">Refresh</button>
        <button class="btn" id="copyUrl" title="Builds a shareable URL using the current textarea (URL-encoded)">Copy URL</button>
      </div>
      <div class="hint" id="status">Ready.</div>
      <div class="small muted">Hover bubbles to see values.</div>
    </div>
  </header>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // --- Map init (GTA default view) ---
  const map = L.map('map').setView([43.6532, -79.3832], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  const statusEl = document.getElementById('status');
  const refreshBtn = document.getElementById('refresh');
  const copyUrlBtn = document.getElementById('copyUrl');
  const inputEl = document.getElementById('input');

  const sizeByEl = document.getElementById('sizeBy');
  const bubbleColorEl = document.getElementById('bubbleColor');
  const bubbleOpacityEl = document.getElementById('bubbleOpacity');
  const bubbleOpacityLabelEl = document.getElementById('bubbleOpacityLabel');
  const twoScaleEl = document.getElementById('twoScale');
  const thresholdMetricEl = document.getElementById('thresholdMetric');
  const thresholdValueEl = document.getElementById('thresholdValue');
  const highColorEl = document.getElementById('highColor');

  let layerGroup = L.layerGroup().addTo(map);

  function parsePasted(text) {
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const rows = [];

    for (const line of lines) {
      const parts = line.includes("\t") ? line.split("\t") : line.split(",");
      if (parts.length < 5) continue;

      const [location, latStr, lngStr, qtyStr, amtStr] = parts.map(p => p.trim());

      const lat = Number(latStr);
      const lng = Number(lngStr);
      const qty = Number(String(qtyStr).replace(/[^\d.-]/g,""));
      const amount = Number(String(amtStr).replace(/[$,]/g,"").replace(/[^\d.-]/g,""));

      if (!location || !isFinite(lat) || !isFinite(lng) || isNaN(qty) || isNaN(amount)) continue;

      rows.push({ location, lat, lng, qty, amount });
    }
    return rows;
  }

  function formatMoney(x) {
    return "$" + Number(x).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function bubbleRadius(qty, amount) {
    const mode = sizeByEl.value;
    const v = mode === "amount" ? Math.max(0, amount) : Math.max(0, qty);
    return Math.max(6, Math.sqrt(v) * (mode === "amount" ? 0.6 : 4));
  }

  function getFillColor(row) {
    const base = bubbleColorEl.value;
    if (!twoScaleEl.checked) return base;

    const metric = thresholdMetricEl.value;
    const threshold = Number(thresholdValueEl.value || 0);
    const value = metric === "qty" ? row.qty : row.amount;

    return value >= threshold ? highColorEl.value : base;
  }

  function render() {
    const rows = parsePasted(inputEl.value);
    layerGroup.clearLayers();

    if (!rows.length) {
      statusEl.textContent = "No valid rows found. Format: Location, Lat, Lng, Qty, Amount";
      return;
    }

    const fillOpacity = Number(bubbleOpacityEl.value);
    bubbleOpacityLabelEl.textContent = fillOpacity.toFixed(2);

    let totalQty = 0;
    let totalAmount = 0;
    const bounds = [];

    rows.forEach(r => {
      totalQty += r.qty;
      totalAmount += r.amount;

      const radius = bubbleRadius(r.qty, r.amount);
      const fillColor = getFillColor(r);

      const marker = L.circleMarker([r.lat, r.lng], {
        radius,
        weight: 1,
        color: fillColor,
        fillColor: fillColor,
        fillOpacity: fillOpacity
      });

      marker.addTo(layerGroup);

      const tip = `<b>${r.location}</b><br>Orders: ${r.qty}<br>Total: ${formatMoney(r.amount)}`;
      marker.bindTooltip(tip, { sticky: true, opacity: 0.95 });
      marker.bindPopup(tip);

      bounds.push([r.lat, r.lng]);
    });

    if (bounds.length) map.fitBounds(bounds, { padding: [30, 30] });

    const twoScaleText = twoScaleEl.checked
      ? `2-scale: ${thresholdMetricEl.value} ≥ ${thresholdValueEl.value} → ${highColorEl.value}`
      : "2-scale: off";

    statusEl.textContent =
      `Done. Locations: ${rows.length}. Total: ${totalQty} orders, ${formatMoney(totalAmount)}. ` +
      `${twoScaleText}.`;
  }

  // --- URL auto-load support ---
  // Use: ?data=<URL-encoded multi-line text>
  function loadFromUrlIfPresent() {
    const params = new URLSearchParams(window.location.search);
    const data = params.get("data");
    if (!data) return false;

    try {
      // URLSearchParams already decodes percent-encoding, but we handle "+" just in case
      const text = data.replace(/\+/g, "%20");
      inputEl.value = decodeURIComponent(text);
      return true;
    } catch (e) {
      // Fallback: use raw if decoding fails
      inputEl.value = data;
      return true;
    }
  }

  refreshBtn.addEventListener('click', render);

  // Auto re-render when settings change (if map already has points)
  const settingsEls = [sizeByEl, bubbleColorEl, bubbleOpacityEl, twoScaleEl, thresholdMetricEl, thresholdValueEl, highColorEl];
  settingsEls.forEach(el => el.addEventListener('change', () => {
    if (layerGroup.getLayers().length > 0) render();
  }));

  bubbleOpacityEl.addEventListener('input', () => {
    bubbleOpacityLabelEl.textContent = Number(bubbleOpacityEl.value).toFixed(2);
  });

  copyUrlBtn.addEventListener('click', async () => {
    const base = window.location.origin + window.location.pathname;
    const encoded = encodeURIComponent(inputEl.value);
    const url = base + "?data=" + encoded;

    try {
      await navigator.clipboard.writeText(url);
      statusEl.textContent = "URL copied to clipboard (includes current data).";
    } catch (e) {
      prompt("Copy this URL:", url);
    }
  });

  // Starter example (only used if no ?data= is present)
  const loaded = loadFromUrlIfPresent();
  if (!loaded) {
    inputEl.value = `Glen Oaks,43.8727,-79.3185,14,5323.08
Mt Hope,43.6932,-79.6200,12,4878.88
Resurrection,43.7684,-79.2983,11,4588.38`;
  }

  bubbleOpacityLabelEl.textContent = Number(bubbleOpacityEl.value).toFixed(2);

  // Auto-render on load if data present
  if (loaded) {
    setTimeout(render, 50);
  }
</script>
</body>
</html>
